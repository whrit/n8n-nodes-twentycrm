# Context Handoff — Twenty CRM n8n Node Updates (2025-10-28)

## Overview
- Extended the Twenty node to cover comprehensive list/get/delete/duplicate operations plus bulk-match capabilities for both people and companies.
- Refined single-company match flow to normalise domain inputs and fall back to name-based search, fixing false negatives observed with bare domains (e.g. `bankstreet.com`).
- Added configurable bulk builders (builder UI, incoming item array, raw JSON) for people and company matches; auto-map common lead structures into Twenty payloads.
- Updated unit tests to capture new operations, routing payloads, and configuration fields, preventing regressions.
- All changes lint- and test-clean (`npm run lint`, `npm test`).

## Key Changes & Rationale
1. **Match Endpoint Normalisation** (`nodes/Twenty/resources/company/index.ts`)
   - Added `normalizeUrl` helper: trims input, injects `https://` when missing, tolerates leading slashes, and respects existing protocols.
   - Escapes filter values and de-duplicates protocols, enabling correct matches when Twenty stores canonical URLs.
   - Optional name filter now uses `name[ilike]` to broaden matches; when both domain and name provided, filters combine via `or()`.

2. **Bulk Match Builders**
   - People (`nodes/Twenty/resources/person/index.ts` / `person/bulkMatch.ts`) and companies (`nodes/Twenty/resources/company/index.ts` / `company/bulkMatch.ts`) now expose:
     - `matchMode` selector (Builder, Incoming Items, Raw JSON).
     - Fixed-collection UI for manual entries (alphabetised fields, lint-compliant descriptions).
     - Auto-mapping logic that inspects typical upstream payloads (e.g. `lead.website`, `match.domain`) and translates them into Twenty’s schema, ensuring the duplicates endpoint receives usable payloads without extra user scripting.
   - Validation ensures at least one candidate survives mapping; descriptive errors guide configuration when inputs are missing.

3. **Response Handling**
   - Single match outputs a structured object `{ matchFound, companyId, company }` rather than an array, simplifying downstream use and preventing empty array cascades.
   - Bulk responses flatten `companyDuplicates` / `personDuplicates` into `matches` arrays alongside `totalCount` and `pageInfo` metadata.

4. **Testing Enhancements** (`tests/twenty.node.test.ts`)
   - Added expectations for new operations, builder fields, and routing shapes.
   - Validated presence of `matchFound`, `companyDuplicates`, and JSON builder fields to guard against accidental reversion.

## Critical Details to Retain
- Bulk match payload builders rely on common path heuristics (`match.domain`, `lead.website`, `emails.primaryEmail`, etc.). Extending support for other CRMs requires editing the field extraction arrays, not the core logic.
- Filters now default to `name[ilike]` when a fallback is required; if Twenty introduces stricter syntax we must revisit this to avoid `or()` parsing issues.
- Normalisation currently prepends `https://` when protocol absent. If Twenty begins storing canonical `http://` URLs, consider adding workspace-level configuration rather than heuristic toggling.
- No schema changes were made to note, people, or company create/update bodies beyond match additions; existing workflows should remain stable.

## Outstanding Issues / Next Steps
- **Validation in Builder Mode**: we only ensure at least one payload is produced. Consider deeper validation (e.g., ensure email or name present per candidate) for better UX.
- **Protocol Variants**: we generate both `https://` and alternate `http://` variations for domain filters; if Twenty accepts domain-only filters, switching to `domainName.primaryLinkUrl[contains]` might be more resilient.
- **Documentation**: update README / usage docs to describe the new match options and filter behaviour (not yet done).
- **Integration Testing**: manual verification against production Twenty instance recommended to confirm duplicates endpoint respects new payload shapes.

## How to Continue
1. **Manual QA**: Run the node against real data similar to the provided sample to confirm matches now resolve (particularly with bulk inputs).
2. **Docs Update**: Add sections to README or `/docs` covering match usage, builder modes, and example mappings.
3. **Extended Mapping**: If other lead providers supply different field names, append them to the `extractFirst` path arrays in the bulk builders.
4. **Optional Enhancements**: consider exposing advanced filter controls (e.g., weighting domain vs name) or supporting additional match strategies from Twenty’s API if available.

## Quick Reference
- Lint/Test commands: `npm run lint`, `npm test`
- Key files touched:
  - `nodes/Twenty/resources/company/index.ts`
  - `nodes/Twenty/resources/person/index.ts`
  - `nodes/Twenty/resources/company/bulkMatch.ts`
  - `nodes/Twenty/resources/person/bulkMatch.ts`
  - `tests/twenty.node.test.ts`

This document should enable the next agent to immediately understand the current state, recent fixes, and where to continue. EOF
